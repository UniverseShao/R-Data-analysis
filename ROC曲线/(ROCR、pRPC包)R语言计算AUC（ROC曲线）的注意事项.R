# 脚本使用注意(和注意事项脚本一起使用！！！)------------------------------------
# 1.准备数据--------------------------------------------------------------------
set.seed(20220840)
ca125_1 <- c(rnorm(10,80,20),rnorm(20,50,10))
ca125_2 <- c(rnorm(10,20,20),rnorm(20,70,10))
class=c(rep(1:0,c(10,20)))

tumor <- c(rep(c("癌症","非癌症"),c(10,20)))

df <- data.frame(`class`=class,`ca125_1`=ca125_1,`ca125_2`=ca125_2,
                 `tumor`=tumor
)
psych::headTail(df)
# 2.ROCR使用注意事项------------------------------------------------------------
library(ROCR)

pred <- prediction(predictions = ca125_1, # 预测指标
                   labels = tumor # 真实结果
)

performance(pred, "auc")@y.values[[1]]#算auc
## [1] 0.075#这计算的是非癌症的auc，也就是真阳性率是非癌症真阳性率


# 2.1指定顺序(手动指定顺序)-----------------------------------------------------

pred <- prediction(predictions = ca125_1, # 预测指标
                   labels = tumor # 真实结果
                   ,label.ordering = c("非癌症","癌症") # 此时就是计算癌症的AUC
)
performance(pred, "auc")@y.values[[1]]

# 3. pROC使用注意事项-----------------------------------------------------------

library(pROC)
# 把ca125_1按照tumor的两个类别进行分组，然后分别计算中位数
tapply(ca125_1, tumor, median)
##     癌症   非癌症 
## 81.34426 49.99926
#结果是癌症组的中位数＞非癌症组的中位数，所以是计算癌症的AUC

#计算AUC：
roc(response=tumor, predictor=ca125_1)
## Area under the curve: 0.9

#再来看看ca125_2这一列指标

# 把ca125_2按照tumor的两个类别进行分组，然后分别计算中位数
tapply(ca125_2, tumor, median)

#结果是癌症组的中位数＜非癌症组，所以是计算非癌症的AUC
roc(response=tumor, predictor=ca125_2)

##### 3.1手动指定---------------------------------------------------------------
#手动指定，需要设置levels和direction
# 此时计算的就是癌症的AUC
roc(response=tumor, predictor=ca125_2,
    levels=c("非癌症", "癌症"), # 这个顺序随便设定，重要的是direction
    direction = "<" # 手动设定非癌症 < 癌症
)
## Area under the curve: 0.1


# 4.手动指定含义解释------------------------------------------------------------
##### 4.1关键点解释：-----------------------------------------------------------

##### 4.2AUC的含义：------------------------------------------------------------
#AUC表示预测指标区分两组的能力，取值范围0-1。
#AUC=0.5表示没有区分能力，AUC>0.5表示有区分能力。
#AUC<0.5表示预测指标的反向预测更好（即值小的组反而对应另一组）。

##### 4.3我们的情况分析：-------------------------------------------------------
#默认情况下roc()函数会按照因子顺序自动选择方向。
#当非癌症组中位数(69.69) > 癌症组中位数(13.53)时：
#默认计算的是"非癌症的AUC"0.9，表示高值预测非癌症效果好
#当手动设定方向为"<"时，计算的是"癌症的AUC"0.1，表示低值预测癌症效果好

##### 4.4为什么AUC会互补：------------------------------------------------------

#这两个AUC是互补的(0.9 + 0.1 = 1)，因为它们只是计算方向相反。
#本质上说明同一个事实：CA125_2的低值对应癌症，高值对应非癌症。

##### 4.5临床意义：-------------------------------------------------------------

#这个结果确实表明CA125_2更适合预测非癌症（因为AUC=0.9）
#但同时它也通过低值提示癌症可能（只是效果较差，AUC=0.1）
#这不是矛盾，而是同一现象的两个视角

##### 4.6建议处理方式-----------------------------------------------------------

#通常我们会报告较高的AUC值(0.9)，并说明：
#"CA125_2作为非癌症的预测指标表现较好(AUC=0.9)，其高值与非癌症状态相关。"

#如果需要预测癌症，可以考虑：
#使用1/CA125_2作为新指标
#寻找其他更有效的肿瘤标志物
#结合多个指标建立模型
