# 序言:⭐卡方检验的双重角色-----------------------------------------------------
"
卡方检验的双重角色：
(1)
独立性检验：检验两变量是否相关
H₀：变量独立（不相关）
H₁：变量相关（拒绝H₀时）
(2)
拟合优度检验：检验数据分布是否符合预期(多项逻辑回归中使用)
H₀：观测分布 = 理论分布
H₁：观测分布 ≠ 理论分布
您的案例本质：

您做的是拟合优度检验（比较模型预测分布 vs 实际数据分布）
p > 0.05 表示 预测分布与实际分布无显著差异 → 模型拟合良好
"

# 1.四格表资料的卡方检验--------------------------------------------------------
rm(list = ls())
ID<-seq(1,200)
treat<-c(rep("treated",104),rep("placebo",96))
treat<- factor(treat)
impro<-c(rep("marked",99),rep("none",5),rep("marked",75),rep("none",21))
impro<-as.factor(impro)
data1<-data.frame(ID,treat,impro)
str(data1)

table(data1$treat,data1$impro)


##### 1.1CrossTable()函数(给出所有结果)-----------------------------------------
CrossTable(data1$treat, data1$impro, digits = 4, expected = T, chisq = T, fisher = T, mcnemar = T, format = "SPSS")
##### 1.2未校正的卡方检验-------------------------------------------------------

mytable <- table(data1$treat,data1$impro)
mytable
chisq.test(mytable,correct = F)

##### 1.3连续校正的卡方检验-----------------------------------------------------
per <- matrix(c(46,6,18,8),
              nrow = 2, byrow = T,
              dimnames = list(group = c("胞磷胆碱","神经节苷脂"),
                              effect = c("有效","无效")
              )
)

per

chisq.test(per, correct = T)
#这只是举个例子，本例子其实更适合使用未校正的卡方检验
##### 1.4四格表资料的方法选择---------------------------------------------------

"(1)
当 n(样本量)≥40 且所有的T(期望频数)≥5时，
用χ2检验的基本公式或四格表资料之χ2检验的专用公式；
当P ≈ α时，改用四格表资料的 Fisher 确切概率法；
α 是 拒绝真实原假设（H₀）的错误概率，即“假阳性”风险
常用值为 0.05（5%），但也可根据研究需求选择 0.01 或 0.10

(2)
当 n≥40 但有 1≤T<5 时，用四格表资料χ2检验的校正公式，
或改用四格表资料的 Fisher 确切概率法。

(3)
当 n<40，或 T<1时，用四格表资料的 Fisher 确切概率法。"

"
       事件发生	事件未发生	总计
实验组	a	        b	        a+b
对照组	c	        d	        c+d
总计	  a+c	      b+d	       n

T = (a+b)(a+c)/n"


# 2.配对四格表资料的卡方检验----------------------------------------------------
##### 2.1mcnemar.test()---------------------------------------------------------
ana <- matrix(c(11,12,2,33), nrow = 2, byrow = T,
              dimnames = list(免疫荧光 = c("阳性","阴性"),
                              乳胶凝集 = c("阳性","阴性")
              )
)

ana
mcnemar.test(ana, correct = T)
##### 2.2配对四格表资料和非配对四格表资料的区分---------------------------------

"
1. 数据结构与设计
(1) 非配对四格表（独立样本）
设计：两组独立样本（如实验组 vs 对照组），每个组别独立测量二分类结果

示例：
比较两种药物（A药和B药）对同一批患者的疗效（有效/无效）。

数据格式：

      有效	无效	总计
A药	   a	   b	   a+b
B药	   c	   d	   c+d
总计	 a+c	b+d	    n

(2) 配对四格表（相关样本）
设计：同一组受试者在两种条件下（如治疗前后、两种检测方法）的二分类结果配对比较

示例
同一批患者用药前后症状是否缓解（是/否）。

数据格式（配对形式）：
用药后\用药前	有效	无效	总计
   有效	        e	   f	  e+f
   无效	        g	   h	  g+h
   总计	        e+g	 f+h	 n

"

# 3.四格表资料的 Fisher 确切概率法----------------------------------------------
"
(3)
当 n<40，或 T<1时，用四格表资料的 Fisher 确切概率法。"

hbv <- matrix(c(4,18,5,6), nrow = 2, byrow = T,
              dimnames = list(组别 = c("预防注射组","非预防组"),
                              效果 = c("阳性","阴性")
              )
)
hbv
fisher.test(hbv)

# 4.行 x 列表资料的卡方检验-----------------------------------------------------

##### 4.1多个样本率的比较-------------------------------------------------------
###### 即比较各组某二分类事件的发生率-------------------------------------------
M <- matrix(c(199,7,164,18,118,26),nrow = 3,byrow = T,
            dimnames = list(trt = c("物理", "药物", "外用"),
                            effect = c("有效","无效")))

M
###### 4.1.1可视化列联表资料----------------------------------------------------
mosaicplot(M)

###### 4.1.2 行 x 列表资料的卡方检验--------------------------------------------
kf <- chisq.test(M, correct = F)
kf
###### 4.1.3仅能用于两列的方法--------------------------------------------------
# 只适用于两列的，类似于 有效/无效 这种！
prop.test(M, correct = TRUE)

##### 4.2样本构成比的比较-------------------------------------------------------
##### 即比较各组在多分类变量中的分布比例----------------------------------------
ace <- matrix(c(42,48,21,30,72,36),nrow = 2,byrow = T,
              dimnames = list(dn = c("dn组","非dn组"),
                              idi = c("dd","id","ii")
              )
)
ace
chisq.test(ace, correct = F)

##### 5.多个样本率的比较和样本构成比的比较的区别--------------------------------

"
特征	    |      多个样本率的比较	       |     样本构成比的比较
研究目标	|比较各组某二分类事件的发生率  |  比较各组在多分类变量中的分布比例
数据类型	|结果变量为二分类（是/否）	   |   结果变量为多分类（≥3类）
"

# 6.双向无序分类资料的关联性检验------------------------------------------------
blood <- matrix(c(431,490,902,388,410,800,495,587,950,137,179,32),
                nrow = 4,byrow = T,
                dimnames = list(abo = c("o","a","b","ab"),
                                mn = c("m","n","mn")
                )
)
blood
mosaicplot(blood)
##### 6.1卡方检验---------------------------------------------------------------
chisq.test(blood,correct = F)
##### 6.2计算列联系数-----------------------------------------------------------
library(vcd)
assocstats(blood)

"
Contingency Coeff(C).: 0.188 
Cramer's V           : 0.136 

C^2 = X^2/(X^2 + N)

0~0.3：弱关联。
0.3~0.7：中等关联。
＞0.7：强关联。

Cramer's V  (更推荐的关联度量)
V^2 = X^2/(n × min(r -1, c-1))
(r和c为行数和列数)
标准化到0~1之间，适合比较不同维度的列联表
"

# 7.双向有序分组资料的线性趋势检验----------------------------------------------
ather <- matrix(c(70,22,4,2,27,24,9,3,16,23,13,7,9,20,15,14),
                nrow = 4,byrow = T,
                dimnames = list(age = c("20~","30~","40~","≥50"),
                                level = c("-","+","++","+++")
                )
)
ather

chisq.test(ather)
##### 7.1双向有序分组资料卡方检验的不足-----------------------------------------

"这种情况下做这种卡方检验并不能说明什么问题，课本是看两者之间有没有线性趋势，我们可以直接用lm()函数做，
把age作为自变量，把level作为因变量即可，由于没有原始数据"
##### 7.2 使用CMHtest（推荐）---------------------------------------------------
library(vcdExtra)
CMHtest(ather, rscores = 1:nrow(ather), cscores = 1:ncol(ather))

##### 7.3 CMHtest()结果解读-----------------------------------------------------s
"
CMHtest(ather, rscores = 1:nrow(ather), cscores = 1:ncol(ather))
Cochran-Mantel-Haenszel Statistics for age by level 

                 AltHypothesis  Chisq Df       Prob
cor        Nonzero correlation 63.389  1 1.6962e-15
rmeans  Row mean scores differ 63.450  3 1.0758e-13
cmeans  Col mean scores differ 65.669  3 3.6072e-14
general    General association 71.176  9 8.9519e-12

统计量	      原假设 (H₀)	                    适用场景
cor行      列变量无线性相关	                 |双向有序变量（检验趋势）
rmeans	   各行平均得分相等	                 |分组变量有序，指标变量无序
cmeans	   各列平均得分相等	                 |分组变量无序，指标变量有序
general    行列变量完全独立（无任何关联）	   |普通卡方检验的扩展



"


# 8.多个样本率间的多重比较------------------------------------------------------
M <- matrix(c(199,7,164,18,118,26),nrow = 3,byrow = T,
            dimnames = list(trt = c("物理", "药物", "外用"),
                            effect = c("有效","无效")))

M

##### 8.1两两比较---------------------------------------------------------------
# 物理治疗组和药物治疗组的卡方检验
chisq.test(M[1:2,], correct = F)
# 物理治疗组和外用膏药组的卡方检验
chisq.test(M[c(1,3),], correct = F)
# 药物治疗组和外用膏药组的卡方检验
chisq.test(M[2:3,], correct = F)

# 9.多个样本构成比的多重比较----------------------------------------------------

ace1 <- matrix(c(42,48,21,30,72,36,24,43,30),nrow = 3,byrow = T,
              dimnames = list(dn = c("dn组","en组","fn组"),
                              idi = c("dd","id","ii")
              )
)
ace1

##### 9.1两两比较---------------------------------------------------------------

# dn组和en组的卡方检验
chisq.test(ace1[1:2,], correct = F)
# dn组和fn组的卡方检验
chisq.test(ace1[c(1,3),], correct = F)
# en组和fn组的卡方检验
chisq.test(ace1[2:3,], correct = F)



# 10.Cochran-Mantel-Haenszel 卡方统计量检验(均分检验)---------------------------

"
(1)常用于按照某个变量进行分层后的检验
(2)用于检验两个有序分类变量是否存在线性相关
(3)因变量是有序变量的单向有序列联表，也可以用
"
##### 10.1某个变量进行分层后的检验----------------------------------------------
myo <- array(c(17,47,
               121,944,
               12,158,
               14,663),
             dim = c(2,2,2),#意思是2行2列2层
             dimnames = list(心肌梗死 = c("病例","对照"),
                             口服避孕药 = c("是","否"),
                             年龄分层 = c("<40岁","≥40岁")
             )
)
myo

mantelhaen.test(myo,correct = F)

##### 10.2mantelhaen.test()使用注意事项-----------------------------------------
# **mantelhaen.test() 默认用于分层 2×2 表**，
#但可以通过 scores 参数扩展用于 双向有序 R×C 表的趋势检验
##### 10.3分层 2×3 表-----------------------------------------------------------
# 构造分层 2×3 表（3层）
my_data <- array(
  c(10, 20, 30,   
    15, 25, 40,   
    5, 10, 15,   
    20, 30, 50,   
    8, 12, 20,    
    12, 18, 30),  
  dim = c(2, 3, 3),  # 2行（暴露），3列（疾病分级），3层
  dimnames = list(
    Exposure = c("Yes", "No"),
    Disease = c("Mild", "Moderate", "Severe"),
    Stratum = c("Center1", "Center2", "Center3")
  )
)
# 先填充第1层（Center1）的所有列，再第2层（Center2），最后第3层（Center3）
my_data

###### 10.3.1情况 1：列变量为无序分类（一般关联性检验）-------------------------
mantelhaen.test(my_data, correct = FALSE)
# 检验各层中 暴露与疾病分级是否独立（类似分层卡方检验）


# 11.单向有序R×C表资料----------------------------------------------------------

##### 11.1情况1：分组变量有序（如年龄），指标变量无序（如传染病类型）-----------
"
研究目的：分析不同年龄组各种传染病的构成情况。
适用方法：行×列表资料的 Pearson 卡方检验（chisq.test）

"
###### 11.1.1构造数据 ----------------------------------------------------------
# 构造数据：年龄（有序） vs. 传染病类型（无序）
data1 <- matrix(
  c(20, 30, 10,   # <20岁：流感、肝炎、麻疹
    15, 25, 20,   # 20~40岁
    10, 15, 30),  # ≥40岁
  nrow = 3,
  byrow = TRUE,
  dimnames = list(
    Age = c("<20岁", "20~40岁", "≥40岁"),
    Disease = c("流感", "肝炎", "麻疹")
  )
)

# 查看数据
data1
###### 11.1.2卡方检验 ----------------------------------------------------------
# Pearson卡方检验（检验年龄组与传染病构成的关联性）
chisq.test(data1)

###### 11.1.3选择卡方检验的原因-------------------------------------------------

"
分析不同年龄组各种传染病的构成情况

统计假设：
H₀：各年龄组的传染病构成比例相同（年龄与传染病类型独立）。
H₁：构成比例不同（存在关联）。

方法选择：
Pearson卡方检验：因为指标变量（传染病）是无序的，
只需检验“比例是否相同”，无需利用年龄的顺序信息


"

##### 11.2 情况2：分组变量无序（如疗法），指标变量有序（如疗效等级）------------

"
研究目的：比较不同疗法的疗效（有序等级）。
适用方法：秩转换的非参数检验（如 Kruskal-Wallis 检验或 CMH 行平均得分检验）


"
###### 11.2.1构造数据并装换成长格式频率表---------------------------------------
# 构造数据：疗法（无序） vs. 疗效（有序：无效、改善、显效）
data2 <- matrix(
  c(10, 20, 30,   # 疗法A：无效、改善、显效
    15, 25, 10,   # 疗法B
    5, 15, 40),   # 疗法C
  nrow = 3,
  byrow = TRUE,
  dimnames = list(
    Therapy = c("A", "B", "C"),
    Effect = c("无效", "改善", "显效")
  )
)
data2
# 转换为长格式频数表（适用于秩检验）
library(tidyr)
data2_long <- as.data.frame(as.table(data2))
names(data2_long) <- c("Therapy", "Effect", "Count")

###### 11.2.2方法1：Kruskal-Wallis 检验（全局比较）-----------------------------
# 生成秩数据（按疗效等级赋分）
data2_long$Effect_score <- factor(data2_long$Effect, 
                                  levels = c("无效", "改善", "显效"),
                                  ordered = TRUE)

# Kruskal-Wallis 检验
kruskal.test(Effect_score ~ Therapy, data = data2_long)

###### 11.2.3方法2：CMH 行平均得分检验（更适用于有序分类）----------------------
library(vcdExtra)
CMHtest(data2, rscores = 1:nrow(data2), cscores = 1:ncol(data2))

###### 11.2.4 CMHtest()结果解读-------------------------------------------------
"
CMHtest(data2, rscores = 1:nrow(data2), cscores = 1:ncol(data2))
Cochran-Mantel-Haenszel Statistics for Therapy by Effect 

                 AltHypothesis   Chisq Df       Prob
cor        Nonzero correlation  3.3252  1 6.8224e-02
rmeans  Row mean scores differ 22.8376  2 1.0987e-05
cmeans  Col mean scores differ  3.5208  2 1.7197e-01
general    General association 24.8806  4 5.3170e-05

统计量	      原假设 (H₀)	                    适用场景
cor行      列变量无线性相关	                 |双向有序变量（检验趋势）
rmeans	   各行平均得分相等	                 |分组变量有序，指标变量无序
cmeans	   各列平均得分相等	                 |分组变量无序，指标变量有序
general    行列变量完全独立（无任何关联）	   |普通卡方检验的扩展
"

##### 11.3单向有序R×C表资料两种形式检验不同的原因-------------------------------
# 因为卡方检验是检验行组之间指标变量的构成差异
# 行组是有序分组变量的时候，因为指标变量（传染病）是无序的，只需检验“比例是否相同”
# 无需利用年龄的顺序信息


# 比较不同疗法的疗效等级是否有差异（如疗法A是否更易导致“显效”）
# 比较不同疗法的疗效等级是否有差异
# 列组是有序分组变量的时候，适用卡方检验检验行组之间的列祖是否有差异
# 就算检验出来了，但是没有体现列祖变量的有序性，所以不能适用卡方检验
# 而要使用秩和检验（如Kruskal-Wallis）或CMH行平均得分检验

# 为什么不能简单互换行列后用卡方检验？
# 因为我的临床问题是探究比较不同疗法的疗效等级是否有差异（如疗法A是否更易导致“显效”）
# 行列变换之后使用卡方检验的意义就变成
# 各疗效等级之间的疗法构成是否有差异、是否显著相关、是否分布相同
# 临床研究的意义和目的都发生改变，所以不行

