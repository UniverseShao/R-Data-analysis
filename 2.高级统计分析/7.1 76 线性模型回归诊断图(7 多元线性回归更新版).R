rm(list = ls())
# ⭐和7 多元线性回归结合使用----------------------------------------------------

# 1.构造数据--------------------------------------------------------------------
df15_1 <- data.frame(
  cho = c(5.68,3.79,6.02,4.85,4.60,6.05,4.90,7.08,3.85,4.65,4.59,4.29,7.97,
          6.19,6.13,5.71,6.40,6.06,5.09,6.13,5.78,5.43,6.50,7.98,11.54,5.84,
          3.84),
  tg = c(1.90,1.64,3.56,1.07,2.32,0.64,8.50,3.00,2.11,0.63,1.97,1.97,1.93,
         1.18,2.06,1.78,2.40,3.67,1.03,1.71,3.36,1.13,6.21,7.92,10.89,0.92,
         1.20),
  ri = c(4.53, 7.32,6.95,5.88,4.05,1.42,12.60,6.75,16.28,6.59,3.61,6.61,7.57,
         1.42,10.35,8.53,4.53,12.79,2.53,5.28,2.96,4.31,3.47,3.37,1.20,8.61,
         6.45),
  hba = c(8.2,6.9,10.8,8.3,7.5,13.6,8.5,11.5,7.9,7.1,8.7,7.8,9.9,6.9,10.5,8.0,
          10.3,7.1,8.9,9.9,8.0,11.3,12.3,9.8,10.5,6.4,9.6),
  fpg = c(11.2,8.8,12.3,11.6,13.4,18.3,11.1,12.1,9.6,8.4,9.3,10.6,8.4,9.6,10.9,
          10.1,14.8,9.1,10.8,10.2,13.6,14.9,16.0,13.2,20.0,13.3,10.4)
)
str(df15_1)
head(df15_1)

# 2.回归前探索数据(ggpairs())---------------------------------------------------
library(GGally)
ggpairs(df15_1) + theme_bw()

# 3.建立模型--------------------------------------------------------------------
f <- lm(fpg ~ cho + tg + ri + hba, data = df15_1)

summary(f)
broom::tidy(f)

# 4.模型评价--------------------------------------------------------------------
library(performance)
r2(f)
AIC(f)
BIC(f)
rmse(f)
# 直接输出所有结果
model_performance(f)

# 5.回归诊断--------------------------------------------------------------------
##### 5.1原始回归诊断图--------------------------------------------------------- 
opar <- par(mfrow = c(2,2))
plot(f)
"
第1幅图（左上）是残差拟合图，展示真实残差和拟合残差的关系，判读是否满足线性这个条件，
如果满足，则应该为一条直线，但是本图明显是一条曲线，说明不是很满足线性这个条件，
可能需要加二次项。

第2幅图（右上）是正态Q-Q图，判断是否满足正态性这个条件，通过这个图来看，基本满足。

第3幅图（左下）是位置尺度图，
判读是否满足同方差性，如果满足，水平线两侧的点应该随机分布，从此图来看基本满足。

第4幅图（右下）是残差杠杆图，用于识别离群点等。
"
##### 5.2现代化的模型诊断图-----------------------------------------------------
library(performance)
check_model(f)

###### 5.2.1图像单独显示--------------------------------------------------------
diagnostic_plots <- plot(check_model(f, panel = FALSE))
###### 5.2.2事后检验图----------------------------------------------------------
diagnostic_plots[[1]]
"
事后检验，是检查真实数据和模型数据的拟合情况的
绿色粗线是真实的预测变量的分布情况
蓝色线条表示模拟的分布，理想的情况应该是完全重合的
从下图来看，其实是有些问题的
"
###### 5.2.3残差图检验线性------------------------------------------------------
diagnostic_plots[[2]]
"
残差拟合图，展示真实残差和拟合残差的关系，判读是否满足线性这个条件，
如果满足，则应该为一条直线，但是本图明显是一条曲线，说明不是很满足线性这个条件，
可能需要加二次项。
"
###### 5.2.4位置尺度图检验方差齐性----------------------------------------------
diagnostic_plots[[3]]

###### 5.2.5识别强影响点或者离群值、异常值--------------------------------------
diagnostic_plots[[4]]
###### 5.2.6识别多重共线性图----------------------------------------------------
diagnostic_plots[[5]]
# 上图中展示了4个变量的VIF，基本都在3以下，可认为不存在多重共线性

###### 5.2.7识别正态性----------------------------------------------------------
diagnostic_plots[[6]]

##### 5.3gvlma包线性模型综合判断-------------------------------------------------
library(gvlma)
gvmodel<-gvlma(f)
summary(gvmodel)
"Call:
  gvlma(x = f) 

                   Value  p-value                   Decision
Global Stat        9.68910 0.046003 Assumptions NOT satisfied!
Skewness           0.65344 0.418886    Assumptions acceptable.
Kurtosis           0.04015 0.841193    Assumptions acceptable.
Link Function      7.68064 0.005582 Assumptions NOT satisfied!
Heteroscedasticity 1.31487 0.251515    Assumptions acceptable.
"
###### 5.3.1综合验证结果解读----------------------------------------------------
"(1) Global Stat (全局检验)
意义：综合评估模型是否满足所有线性回归假设。
你的结果：
p = 0.046 (<0.05) → 模型假设整体上不满足，需进一步检查具体问题。

(2) Skewness (偏度检验)
检验内容：残差是否对称分布（是否偏斜）。
你的结果：
p = 0.419 (>0.05) → 残差分布对称性可接受。

(3) Kurtosis (峰度检验)
检验内容：残差是否服从正态分布的峰度（尾部厚度）。
你的结果：
p = 0.841 (>0.05) → 残差峰度符合正态分布假设。

(4) Link Function (链接函数)
检验内容：因变量与预测变量之间是否是线性关系（或需非线性变换）。
你的结果：
p = 0.006 (<0.05) → 线性关系假设不成立，可能存在：
非线性关系（如二次项、交互项未纳入模型）。
因变量需转换（如对数变换、Box-Cox变换）。

(5) Heteroscedasticity (异方差性)
检验内容：残差的方差是否恒定（即是否随预测值变化）。
你的结果：
p = 0.252 (>0.05) → 无异方差性问题，方差稳定性可接受"

###### 5.3.2针对单独的条件进行判断----------------------------------------------
###### 5.3.3正态性的判断--------------------------------------------------------
par(opar)
library(car)

# 验证正态性
qqPlot(f,labels = row.names(df15_1), id.method = "identify",simulate = T,
       main = "Q-Q plot")   

check_normality(f)
# OK: residuals appear as normally distributed (p = 0.671).
###### 5.3.4检测离群值，基于cook距离--------------------------------------------
check_outliers(f)
###### 5.3.5检测残差（或者因变量）独立性----------------------------------------
set.seed(123)
check_autocorrelation(f)
# OK: Residuals appear to be independent and not autocorrelated (p = 0.296).
# 或者通过car包
set.seed(123)
# 验证因变量独立性
durbinWatsonTest(f) 
###### 5.3.6验证线性------------------------------------------------------------

crPlots(f)

###### 5.3.7检测方差齐性--------------------------------------------------------
ncvTest(f)   
#P值大于0.05，方差齐性满足
# performance检测方差齐性
check_heteroscedasticity(f)
###### 5.3.8重共线性的检验------------------------------------------------------
vif(f)
vif(f)>4
check_collinearity(f)

"
VIF的通用判断标准
VIF < 5：一般认为不存在显著的多重共线性（模型安全）。
5 ≤ VIF < 10：存在中度共线性，需警惕但可能无需立即处理。
VIF ≥ 10：存在严重多重共线性，必须处理（删除变量、合并或正则化）

为什么说一个变量VIF高，说明至少两个变量共线
VIF高的本质：某个变量（如 X 1）的VIF高，是因为它与其他一个或多个变量（如 X 2
,X 3）高度相关

共线性是双向的
(1)若 X 1和 X 2高度相关，则 X 1的VIF高，X 2的VIF通常也会高
(2)但若某个变量（如 X 3）与多个变量弱相关，可能只有 X 3的VIF高，而其他变量VIF正常
示例：
假设X 1=2X 2+噪声，则
X 1的VIF高（因能被 X 2解释）
X 2的VIF可能不高（若 X 2独立于其他变量）
"
