# 1.有序逻辑回归----------------------------------------------------------------
##### 1.1构造数据，并因子化-----------------------------------------------------
rm(list = ls())
library(nnet) #加载nnet包，调用multinom()函数
library(car) #加载car包，调用Anova()函数
library(data.table)  #加载data.table包，调用melt()函数
library(ggplot2)  #加载ggplot2包，用于数据可视化
library(survival) #加载survival包
str(colon) #查看数据集的样本量、变量数、各变量的类型、值标签等

colon$rx <- as.factor(colon$rx) #将rx转换为因子
colon$rx <- factor(colon$rx, levels = c("Obs", "Lev", "Lev+5FU"), 
                   labels = c("术式1", "术式2", "术式3"), 
                   ordered = T) #将rx转换为有序因子
colon$extent <- as.factor(colon$extent) #将extent转换为因子
str(colon)
##### 1.2有序Logistic回归(MASS::polr)-------------------------------------------
library(MASS)
fit <- polr(rx ~ extent + age, data = colon,Hess = TRUE,method = "logistic")
summary(fit)
broom::tidy(fit)

###### 1.2.1结果解释------------------------------------------------------------
"
Coefficients:
            Value Std. Error t value
extent2 -0.383401   0.332277 -1.1539
extent3 -0.249402   0.310884 -0.8022
extent4 -0.745682   0.368771 -2.0221
age      0.001403   0.003601  0.3897

Intercepts:
            Value   Std. Error t value
术式1|术式2 -0.8676  0.3692    -2.3498
术式2|术式3  0.5250  0.3688     1.4233

extent2	-0.383	
肿瘤扩散程度为2级 vs 1级时，选择更高术式的几率降低0.383（不显著，p > 0.05）
截距项（Intercepts）
表示因变量不同类别间的分界点（阈值）：
(1)
术式1|术式2：-0.868
当线性预测值 ≤ -0.868时，更可能选择术式1
介于 -0.868 和 0.525 之间时，选择术式2
(2)
术式2|术式3：0.525
当线性预测值 > 0.525时，更可能选择术式3
"
##### 1.3手动计算P值------------------------------------------------------------
p <- pnorm(abs(coef(summary(fit))[, "t value"]),lower.tail = F)*2
p

##### 1.4OR值-------------------------------------------------------------------
OR <- exp(coef(fit))
OR

##### 1.5平行线检验(Brant-Wald test)--------------------------------------------
brant::brant(fit)
###### 1.5.1平行线检验结果解读--------------------------------------------------

"
Omnibus检验：χ²=14.75, p=0.01 (p < 0.05)
→ 拒绝平行线假设，表明至少有一个变量的系数在不同因变量类别间存在显著差异。
变量级检验：
extent2 (p=0.002)、extent3 (p<0.001)、extent4 (p=0.05) 显著违反假设
age (p=0.42) 满足假设

检验项	    χ²值	    p值	      结论
Omnibus     14.75	    0.01	    模型整体违反平行线假设
extent2	    9.57	    0.002	    该变量系数在不同类别间显著不同
extent3	    13.16	    <0.001	  该变量系数差异极显著
extent4	    3.91	    0.05	    在边界显著（需谨慎）
age	        0.64	    0.42	    满足平行假设
"
# 若P值>0.05，平行线检验通过，可以使用有序逻辑回归，通不过可以用多项逻辑回归
# 平行检验通过就是说
# 变量的系数在不同因变量类别间不存在差异
# 若P值<0.05, 表明至少有一个变量的系数在不同因变量类别间存在显著差异

##### 1.6模型整体的显著性检验---------------------------------------------------
# 先构建一个只有截距的模型
fit0 <- polr(rx ~ 1, data = colon,Hess = TRUE,method = "logistic")
# 两个模型比较
anova(fit0, fit)
# P值＜0.01，模型是有意义的

##### 1.7获取模型预测的类别-----------------------------------------------------
pred <- predict(fit, colon, type = "class")
head(pred)

##### 1.8获取模型预测的概率-----------------------------------------------------
prob <- predict(fit, colon, type = "probs")
head(prob)
# 或
prob <- fitted(fit)
head(prob)

##### 1.9模型拟合优度的检验-----------------------------------------------------
chisq.test(colon$rx, pred)
# P值>0.05，不拒绝原假设，观察到的数据和期望数据没有显著差异(和分类变量卡方有区别)

# ⭐卡方检验的双重角色----------------------------------------------------------
"
卡方检验的双重角色：
(1)
独立性检验：检验两变量是否相关
H₀：变量独立（不相关）
H₁：变量相关（拒绝H₀时）
(2)
拟合优度检验：检验数据分布是否符合预期
H₀：观测分布 = 理论分布
H₁：观测分布 ≠ 理论分布
您的案例本质：

您做的是拟合优度检验（比较模型预测分布 vs 实际数据分布）
p > 0.05 表示 预测分布与实际分布无显著差异 → 模型拟合良好
"

##### 1.10计算伪R2--------------------------------------------------------------
DescTools::PseudoR2(fit, which = "all")

